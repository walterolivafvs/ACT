<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard ACTs</title>

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --card:#fff; --border:#e7e7e7; --muted:#666; }

    body { font-family: Arial, sans-serif; margin: 18px 24px; background:#fafafa; }
    h3 { margin: 10px 0 10px 0; }

    /* ===== HEADER INSTITUCIONAL ===== */
    .topbar{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 8px 0 16px 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .brand-logos{
      display:flex; align-items:center; gap:12px;
      padding-right:14px; border-right:1px solid #eee;
    }
    .logo{ display:block; height:54px; width:auto; object-fit:contain; }
    .logo.fvs{ height:48px; }
    .logo.depi{ height:54px; border-radius:8px; }

    .brand-text .org{
      font-size:12px; color:var(--muted); letter-spacing:.5px; text-transform:uppercase;
      margin-bottom:2px;
    }
    .brand-text .title{ margin:0; font-size:30px; line-height:1.15; }
    .brand-text .subtitle{ margin-top:4px; font-size:13px; color:var(--muted); }

    /* ===== CARDS / PAINÉIS ===== */
    .cards { display:flex; gap:12px; flex-wrap:wrap; margin: 14px 0 18px 0; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:14px 16px; min-width:220px; box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .card .label { color:var(--muted); font-size:12px; }
    .card .value { font-size:28px; font-weight:800; margin-top:6px; }

    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:12px; flex:1; min-width:380px;
    }

    /* ===== LEGENDA ===== */
    .legenda{
      background:#f9f9f9; border:1px solid #ddd; border-radius:10px;
      padding:10px 14px; margin:10px 0 14px 0;
      font-size:13px; line-height:1.5;
    }
    .legenda strong{ color:#333; }
    .legenda span{ color:#555; }

    /* ===== BUSCA / TABELA ===== */
    #search{
      width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; margin:10px 0;
      font-size:14px;
    }

    .tableWrap{ overflow:auto; max-height:560px; border:1px solid #eee; border-radius:12px; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td{ border-bottom:1px solid #eee; padding:8px 10px; font-size:13px; vertical-align:top; }
    th{ font-weight:700; background:#fbfbfb; position: sticky; top:0; z-index:1; text-align:center; white-space:nowrap; }

    /* larguras por coluna (1..10) */
    #tbl th:nth-child(1), #tbl td:nth-child(1){ width:90px;  text-align:left; white-space:nowrap; }
    #tbl th:nth-child(2), #tbl td:nth-child(2){ width:80px;  text-align:center; }
    #tbl th:nth-child(3), #tbl td:nth-child(3){
      width:330px; white-space:normal; word-break:break-word; line-height:1.25;
    }
    #tbl th:nth-child(4), #tbl td:nth-child(4){ width:130px; text-align:center; }
    #tbl th:nth-child(5), #tbl td:nth-child(5){ width:140px; text-align:center; }
    #tbl th:nth-child(6), #tbl td:nth-child(6){ width:105px; text-align:center; }
    #tbl th:nth-child(7), #tbl td:nth-child(7){ width:115px; text-align:center; }
    #tbl th:nth-child(8), #tbl td:nth-child(8){ width:90px;  text-align:center; }
    #tbl th:nth-child(9), #tbl td:nth-child(9){ width:200px; text-align:center; }
    #tbl th:nth-child(10),#tbl td:nth-child(10){ width:100px; text-align:center; }

    .btn{
      border:1px solid #ccc; background:#f5f5f5; border-radius:8px;
      padding:4px 10px; cursor:pointer; font-size:12px; min-width:54px;
    }
    .detailsBox{
      border:1px solid #eee; border-radius:10px; padding:10px; background:#fff;
      min-width:380px; text-align:left;
    }
    .kv{ display:grid; grid-template-columns:140px 1fr; gap:6px 10px; margin-bottom:8px; }
    .k{ color:#444; font-weight:700; }
    .v{ color:#111; }

    details{ margin-top:8px; }
    summary{ cursor:pointer; font-weight:700; }
    ul{ margin:6px 0 0 18px; padding:0; }
    li{ margin:4px 0; }
    .muted{ color:#888; }
  /* ===== LEGENDA DE RISCO (gráfico de vencimentos) ===== */
.legend-risk {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 8px;
  font-size: 12px;
  color: #444;
}

.legend-risk .item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-risk .box {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  border: 1px solid #ccc;
}

.legend-risk .red    { background: #dc2626; }
.legend-risk .yellow { background: #f59e0b; }
.legend-risk .green  { background: #16a34a; }
.legend-risk .gray   { background: #9ca3af; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-logos">
        <img class="logo fvs" src="./fvs-logo.png" alt="FVS-RCP" />
        <img class="logo depi" src="./logo_depi.jpeg" alt="DEPI - FVS-RCP" />
      </div>
      <div class="brand-text">
        <div class="org">FVS-RCP • DEPI</div>
        <h1 class="title">Controle de ACTs e Convênios</h1>
        <div class="subtitle">Painel de monitoramento de vigência e renovação</div>
      </div>
    </div>
  </header>

  <div class="cards">
    <div class="card"><div class="label">Total</div><div class="value" id="kpi_total">—</div></div>
    <div class="card"><div class="label">Vigentes</div><div class="value" id="kpi_vigente">—</div></div>
    <div class="card"><div class="label">Alerta (≤180 dias)</div><div class="value" id="kpi_alerta">—</div></div>
    <div class="card"><div class="label">Sem data</div><div class="value" id="kpi_semdata">—</div></div>
  </div>

  <div class="row">
  <div class="panel">
    <h3>Status de vigência</h3>
    <div id="chart_status"></div>
  </div>

  <div class="panel">
    <h3>Vencimentos por mês</h3>

    <div class="legend-risk">
      <div class="item">
        <span class="box red"></span>
        <span>&lt; 1 ano (crítico)</span>
      </div>
      <div class="item">
        <span class="box yellow"></span>
        <span>1–2 anos (atenção)</span>
      </div>
      <div class="item">
        <span class="box green"></span>
        <span>&gt; 2 anos (vigência confortável)</span>
      </div>
      <div class="item">
        <span class="box gray"></span>
        <span>Sem data</span>
      </div>
    </div>

    <div id="chart_venc"></div>
  </div>
</div>

  <div class="panel" style="margin-top:14px;">
    <h3>Instrumentos</h3>

    <div class="legenda">
      <strong>Legenda</strong><br>
      <span><strong>ACT</strong> = Acordo de Cooperação Técnica</span><br>
      <span><strong>Convênio</strong> = Convênio</span><br>
      <span><strong>TC</strong> = Termo de Colaboração</span><br>
    </div>

    <input id="search" placeholder="Buscar (identificação, instituição, processo, status...)" />
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Identificação</th>
            <th>Tipo</th>
            <th>Instituição</th>
            <th>Setor</th>
            <th>Status</th>
            <th>Início</th>
            <th>Vencimento</th>
            <th>Aditivos</th>
            <th>Processo</th>
            <th>Detalhes</th>
          </tr>
        </thead>
        <tbody id="tbl_body"></tbody>
      </table>
    </div>
  </div>

<script>
/* =========================
   UTIL
========================= */
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => resolve(results.data || []),
      error: (err) => reject(err)
    });
  });
}

function isBlank(v) {
  return v === undefined || v === null || String(v).trim() === "" || String(v).trim().toLowerCase() === "nan";
}

function getFirst(row, keys) {
  for (const k of keys) {
    if (row && Object.prototype.hasOwnProperty.call(row, k) && !isBlank(row[k])) return String(row[k]).trim();
  }
  return "";
}

function escapeHTML(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   DATAS / RISCO
========================= */
function parseDateBR(raw) {
  if (!raw) return null;
  const s = String(raw).trim().slice(0, 10);

  // dd/mm/yyyy ou dd-mm-yyyy
  let m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
  if (m) {
    const dd = Number(m[1]), mm = Number(m[2]) - 1, yy = Number(m[3]);
    const d = new Date(yy, mm, dd);
    return isNaN(d.getTime()) ? null : d;
  }

  // yyyy-mm-dd
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) {
    const yy = Number(m[1]), mm = Number(m[2]) - 1, dd = Number(m[3]);
    const d = new Date(yy, mm, dd);
    return isNaN(d.getTime()) ? null : d;
  }

  return null;
}

function formatDateBR(raw) {
  if (isBlank(raw)) return "";
  const s = String(raw).trim().slice(0, 10);

  // yyyy-mm-dd -> dd/mm/yyyy
  const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m1) return `${m1[3]}/${m1[2]}/${m1[1]}`;

  // dd/mm/yyyy já OK
  const m2 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (m2) return s;

  // dd-mm-yyyy -> dd/mm/yyyy
  const m3 = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (m3) return `${m3[1]}/${m3[2]}/${m3[3]}`;

  return s;
}

function daysTo(d) {
  if (!d) return null;
  const now = new Date();
  const ms = d.getTime() - now.getTime();
  return Math.floor(ms / (1000 * 60 * 60 * 24));
}

function riskColorFromDays(days) {
  if (days == null) return "#9ca3af";   // sem data
  if (days < 0)    return "#7f1d1d";    // vencido
  if (days < 365)  return "#dc2626";    // < 1 ano
  if (days < 730)  return "#f59e0b";    // 1-2 anos
  return "#16a34a";                     // > 2 anos
}

function monthKeyPT(dateObj) {
  const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  return `${meses[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
}

/* =========================
   TEXTO (bullets)
========================= */
function splitBullets(text) {
  if (isBlank(text)) return [];
  const t = String(text).trim();
  const parts = t
    .split(/\r?\n|;|\|/g)
    .map(p => p.trim())
    .filter(p => p.length > 0);
  return parts.length ? parts : [t];
}

function makeUl(items) {
  if (!items || !items.length) return `<div class="muted">—</div>`;
  return `<ul>${items.map(i => `<li>${escapeHTML(i)}</li>`).join("")}</ul>`;
}

/* =========================
   INIT
========================= */
(async function init() {
  console.log("[INIT] começou");

  const base = "./data/";
  const csvPath = base + "tbl_instrumentos.csv";

  const tblRaw = await loadCSV(csvPath);
  console.log("[CSV] linhas:", tblRaw.length, "path:", csvPath);

  const tbl = (tblRaw || []).filter(r => r && Object.values(r).some(v => !isBlank(v)));
  console.log("[TBL] linhas válidas:", tbl.length);

  // ===== KPIs =====
  document.getElementById("kpi_total").textContent = tbl.length;

  const counts = { "VIGENTE": 0, "ALERTA 180 DIAS": 0, "SEM DATA": 0 };

  tbl.forEach(r => {
    const status = String(getFirst(r, ["status_vigencia","status_vencimento","alerta_180_dias","status","Status"]) || "").toUpperCase();

    if (!status || status.includes("SEM DATA")) counts["SEM DATA"]++;
    else if (status.includes("ALERTA")) counts["ALERTA 180 DIAS"]++;
    else if (status.includes("VIGENTE")) counts["VIGENTE"]++;
    else counts["SEM DATA"]++;
  });

  document.getElementById("kpi_vigente").textContent = counts["VIGENTE"];
  document.getElementById("kpi_alerta").textContent  = counts["ALERTA 180 DIAS"];
  document.getElementById("kpi_semdata").textContent = counts["SEM DATA"];

  // ===== Gráfico 1 (Status) =====
  const x1 = Object.keys(counts);
  const y1 = Object.values(counts);

  Plotly.newPlot(
    "chart_status",
    [{ type:"bar", x:x1, y:y1, showlegend:false }],
    { margin:{t:10,l:40,r:10,b:50}, xaxis:{automargin:true}, yaxis:{automargin:true} },
    { displayModeBar:false }
  );

  // ===== Gráfico 2 (Vencimentos por mês + cores por risco do mês) =====
  const byMonth = {};
  const minDaysByMonth = {};

  tbl.forEach(r => {
    const rawVenc = getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento"]);
    const d = parseDateBR(rawVenc);
    if (!d) return;

    const key = monthKeyPT(d);
    byMonth[key] = (byMonth[key] || 0) + 1;

    const dias = daysTo(d);
    if (minDaysByMonth[key] === undefined || dias < minDaysByMonth[key]) {
      minDaysByMonth[key] = dias;
    }
  });

  const order = Object.keys(byMonth).map(k => {
    const [mon, yr] = k.split(" ");
    const meses = {Jan:0,Fev:1,Mar:2,Abr:3,Mai:4,Jun:5,Jul:6,Ago:7,Set:8,Out:9,Nov:10,Dez:11};
    return { k, t: new Date(Number(yr), meses[mon], 1).getTime() };
  }).sort((a,b) => a.t - b.t);

  const x2 = order.map(o => o.k);
  const y2 = order.map(o => byMonth[o.k]);
  const colors2 = x2.map(k => riskColorFromDays(minDaysByMonth[k]));

  Plotly.newPlot(
    "chart_venc",
    [{
      type:"bar",
      x:x2,
      y:y2,
      marker: { color: colors2 },
      showlegend:false
    }],
    { margin:{t:10,l:40,r:10,b:50}, xaxis:{automargin:true}, yaxis:{automargin:true} },
    { displayModeBar:false }
  );

  // ===== Tabela + Detalhes =====
  const body = document.getElementById("tbl_body");

  function render(rows) {
    body.innerHTML = "";

    rows.forEach((r, idx) => {
      const ident = getFirst(r, ["identificacao","Identificação","id_instrumento"]);
      const inst  = getFirst(r, ["instituicao_parceira","instituicao","Instituição"]);
      const tipo  = getFirst(r, ["tipo_instrumento","Tipo"]);
      const proc  = getFirst(r, ["numero_processo","Processo"]);

      const inicio = formatDateBR(getFirst(r, ["vigencia_inicio","VIGÊNCIA - INÍCIO","inicio"]));
      const venc   = formatDateBR(getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento"]));

      const stat = String(getFirst(r, ["status_vigencia","status_vencimento","Status","status"]) || "").toUpperCase();
      const setor = getFirst(r, ["setor_lotacao","Setor","setor"]);

      const possuiAditivoRaw = getFirst(r, ["possui_aditivo","aditivo","Aditivo"]);
      const qtdAditivosRaw   = getFirst(r, ["quantos_aditivos","Qtd Aditivos","qtd_aditivos"]);
      const possuiAditivo = (possuiAditivoRaw ? String(possuiAditivoRaw) : "").trim().toUpperCase();
      const qtdAditivos   = (qtdAditivosRaw ? String(qtdAditivosRaw) : "").trim();

      let aditivosLabel = "NÃO";
      if (["SIM","S","TRUE","1"].includes(possuiAditivo)) {
        aditivosLabel = qtdAditivos ? `SIM (${qtdAditivos})` : "SIM";
      } else if (["NÃO","NAO","N","FALSE","0",""].includes(possuiAditivo)) {
        aditivosLabel = "NÃO";
      } else if (possuiAditivoRaw) {
        aditivosLabel = String(possuiAditivoRaw);
      }

      const coordParceiro = r.coordenador_parceiro || "";
      const respFvs = r.coordenador_fvsrcp || "";
      const repasse = r.repasse_financeiro || "";

      const objetivoTexto = getFirst(r, ["objetivo_resumido","objetivo_geral","objeto"]);
      const produtosTexto = getFirst(r, ["produtos_gerados","produtos_gerados.1"]);

      const objetivoItens = splitBullets(objetivoTexto);
      const produtosItens = splitBullets(produtosTexto);

      const tr = document.createElement("tr");
      const detailsId = `details_${idx}`;
      const btnId = `btn_${idx}`;

      tr.innerHTML = `
        <td>${escapeHTML(ident || "—")}</td>
        <td>${escapeHTML(tipo || "—")}</td>
        <td>${escapeHTML(inst || "—")}</td>
        <td>${escapeHTML(setor || "—")}</td>
        <td>${escapeHTML(stat || "—")}</td>
        <td>${escapeHTML(inicio || "—")}</td>
        <td>${escapeHTML(venc || "—")}</td>
        <td>${escapeHTML(aditivosLabel || "NÃO")}</td>
        <td>${escapeHTML(proc || "—")}</td>
        <td>
          <button class="btn" id="${btnId}">Ver</button>
          <div id="${detailsId}" style="display:none; margin-top:10px;">
            <div class="detailsBox">
              <div class="kv">
                <div class="k">Coord. parceiro:</div><div class="v">${escapeHTML(coordParceiro || "—")}</div>
                <div class="k">Resp. FVS:</div><div class="v">${escapeHTML(respFvs || "—")}</div>
                <div class="k">Repasse:</div><div class="v">${escapeHTML(repasse || "—")}</div>
              </div>

              <details ${objetivoItens.length ? "open" : ""}>
                <summary>Objetivo</summary>
                ${makeUl(objetivoItens)}
              </details>

              <details>
                <summary>Produtos</summary>
                ${makeUl(produtosItens)}
              </details>
            </div>
          </div>
        </td>
      `;

      body.appendChild(tr);

      const btn = tr.querySelector(`#${btnId}`);
      const box = tr.querySelector(`#${detailsId}`);
      btn.addEventListener("click", () => {
        const open = box.style.display !== "none";
        box.style.display = open ? "none" : "block";
        btn.textContent = open ? "Ver" : "Fechar";
      });
    });
  }

  render(tbl);

  // ===== filtro =====
  const search = document.getElementById("search");
  search.addEventListener("input", () => {
    const q = search.value.toLowerCase().trim();
    if (!q) return render(tbl);
    const filtered = tbl.filter(r => Object.values(r).join(" ").toLowerCase().includes(q));
    render(filtered);
  });

})().catch(err => {
  console.error("[INIT] ERRO:", err);
  alert("Erro ao carregar o CSV. Abra o Console (F12) para ver o detalhe.");
});
</script>
</body>
</html>