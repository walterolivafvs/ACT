<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de ACTs e Convênios</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root { --card:#fff; --border:#e7e7e7; --muted:#666; }
    body { font-family: Arial, sans-serif; margin: 18px 24px; background:#fafafa; }
    h3 { margin: 10px 0 10px 0; }

    /* header institucional */
    .topbar{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 8px 0 16px 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .brand-logos{
      display:flex; align-items:center; gap:12px;
      padding-right:14px; border-right:1px solid #eee;
    }
    .logo{ display:block; height:54px; width:auto; object-fit:contain; }
    .logo.fvs{ height:48px; }
    .logo.depi{ height:54px; border-radius:8px; }

    .brand-text .org{ font-size:12px; color:var(--muted); letter-spacing:.5px; text-transform:uppercase; margin-bottom:2px; }
    .brand-text .title{ margin:0; font-size:30px; line-height:1.15; }
    .brand-text .subtitle{ margin-top:4px; font-size:13px; color:var(--muted); }

    /* cards KPIs */
    .cards { display:flex; gap:12px; flex-wrap:wrap; margin: 14px 0 18px 0; }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      min-width: 220px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .card .label { color:var(--muted); font-size:12px; }
    .card .value { font-size:28px; font-weight:800; margin-top:6px; }

    /* linha de gráficos */
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      flex: 1;
      min-width: 380px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    #chart_status, #chart_venc { width:100%; height:320px; }

    /* instrumentos / legenda */
    .legenda{
      background:#f9f9f9;
      border:1px solid #ddd;
      border-radius:10px;
      padding:10px 12px;
      font-size: 12px;
      color:#444;
    }

    /* busca */
    #search{
      width:100%;
      margin-top: 10px;
      padding: 10px 12px;
      border:1px solid #ddd;
      border-radius:10px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }

    /* tabela */
    .tableWrap{ margin-top: 10px; border:1px solid #eee; border-radius:12px; overflow:hidden; background:#fff; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td{ border-bottom:1px solid #eee; padding:8px 10px; font-size:13px; vertical-align:top; }
    th{ font-weight:700; background:#fbfbfb; position:sticky; top:0; z-index:1; text-align:left; }
    td{ word-break:break-word; }
    .tableBody{ max-height: 420px; overflow:auto; }

    /* larguras por coluna (1..10) */
    #tbl th:nth-child(1), #tbl td:nth-child(1){ width:90px; }
    #tbl th:nth-child(2), #tbl td:nth-child(2){ width:80px; }
    #tbl th:nth-child(3), #tbl td:nth-child(3){ width:330px; }
    #tbl th:nth-child(4), #tbl td:nth-child(4){ width:130px; text-align:center; }
    #tbl th:nth-child(5), #tbl td:nth-child(5){ width:120px; text-align:center; }
    #tbl th:nth-child(6), #tbl td:nth-child(6){ width:105px; text-align:center; }
    #tbl th:nth-child(7), #tbl td:nth-child(7){ width:115px; text-align:center; }
    #tbl th:nth-child(8), #tbl td:nth-child(8){ width:90px; text-align:center; }
    #tbl th:nth-child(9), #tbl td:nth-child(9){ width:200px; text-align:center; }
    #tbl th:nth-child(10), #tbl td:nth-child(10){ width:160px; }

    .btn{
      border:1px solid #ccc;
      background:#f5f5f5;
      border-radius:8px;
      padding:4px 10px;
      cursor:pointer;
      font-size:12px;
      min-width:54px;
    }
    .detailsBox{
      border:1px solid #eee;
      border-radius:10px;
      padding:10px;
      background:#fff;
      min-width:380px;
      text-align:left;
    }
    .kv{ display:grid; grid-template-columns:140px 1fr; gap:6px 10px; margin-bottom:8px; }
    .k{ color:#444; font-weight:700; }
    .v{ color:#111; }
    details{ margin-top:8px; }
    summary{ cursor:pointer; font-weight:700; }

    ul{ margin:6px 0 18px; padding:0; }
    li{ margin:4px 0; }

    .muted{ color:#888; }

    /* ===== LEGENDA DE RISCO (gráfico de vencimentos) ===== */
    .legend-risk {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 12px;
      color: #444;
    }
    .legend-risk .item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-risk .box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid #ccc;
      display: inline-block;
    }
    .legend-risk .red { background: #d62c26; }
    .legend-risk .yellow { background: #f59e0b; }
    .legend-risk .green { background: #16a34a; }
    .legend-risk .gray { background: #9ca3af; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-logos">
        <!-- ajuste para seus arquivos -->
        <img class="logo fvs" src="./fvs-logo.png" alt="FVS-RCP" />
        <img class="logo depi" src="./logo_depi.jpeg" alt="DEPI - FVS-RCP" />
      </div>

      <div class="brand-text">
        <div class="org">FVS-RCP • DEPI</div>
        <h1 class="title">Controle de ACTs e Convênios</h1>
        <div class="subtitle">Painel de monitoramento de vigência e renovação</div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <div class="cards">
    <div class="card">
      <div class="label">Total</div>
      <div class="value" id="kpi_total">—</div>
    </div>
    <div class="card">
      <div class="label">Vigentes</div>
      <div class="value" id="kpi_vigentes">—</div>
    </div>
    <div class="card">
      <div class="label">Alerta (≤180 dias)</div>
      <div class="value" id="kpi_alerta">—</div>
    </div>
    <div class="card">
      <div class="label">Sem data</div>
      <div class="value" id="kpi_semdata">—</div>
    </div>
  </div>

  <!-- gráficos -->
  <div class="row">
    <div class="panel">
      <h3>Status de vigência</h3>
      <div id="chart_status"></div>
    </div>

    <div class="panel">
      <h3>Vencimentos por mês</h3>

      <!-- legenda do risco -->
      <div class="legend-risk">
        <div class="item"><span class="box red"></span><span>&lt; 1 ano (crítico)</span></div>
        <div class="item"><span class="box yellow"></span><span>1–2 anos (atenção)</span></div>
        <div class="item"><span class="box green"></span><span>&gt; 2 anos (vigência confortável)</span></div>
        <div class="item"><span class="box gray"></span><span>Sem data</span></div>
      </div>

      <div id="chart_venc"></div>
    </div>
  </div>

  <!-- instrumentos + busca + tabela -->
  <div class="panel" style="margin-top:14px;">
    <h3>Instrumentos</h3>

    <div class="legenda">
      <strong>Legenda</strong><br>
      <span><strong>ACT</strong> = Acordo de Cooperação Técnica</span><br>
      <span><strong>Convênio</strong> = Convênio</span><br>
      <span><strong>TC</strong> = Termo de Colaboração</span>
    </div>

<div style="display:flex; gap:8px; margin-bottom:8px;">
  <input id="search" placeholder="Buscar (identificação, instituição, processo, status...)" />
  <button id="resetFilters" class="btn">Ver todos</button>
</div>
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Identificação</th>
            <th>Tipo</th>
            <th>Instituição</th>
            <th>Setor</th>
            <th>Status</th>
            <th>Início</th>
            <th>Vencimento</th>
            <th>Aditivos</th>
            <th>Processo</th>
            <th>Detalhes</th>
          </tr>
        </thead>
      </table>
      <div class="tableBody">
        <table>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // AJUSTE AQUI
    // =========================
    const CSV_URL = "./data/tbl_instrumentos.csv"; // <-- coloque aqui o nome do seu CSV

    (async function init() {
      const body = document.getElementById("tbody");
      const kpi_total = document.getElementById("kpi_total");
      const kpi_vigentes = document.getElementById("kpi_vigentes");
      const kpi_alerta = document.getElementById("kpi_alerta");
      const kpi_semdata = document.getElementById("kpi_semdata");

      // ===== helpers =====
      function escapeHTML(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function getFirst(obj, keys) {
        for (const k of keys) {
          if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
        }
        return "";
      }

      function formatDateBR(raw) {
        const d = parseDateAny(raw);
        if (!d) return "";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }

      function parseDateAny(raw) {
        if (!raw) return null;
        if (raw instanceof Date && !isNaN(raw)) return raw;

        const s = String(raw).trim();
        // dd/mm/yyyy
        const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (m) {
          const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
          const d = new Date(yy, mm - 1, dd);
          return isNaN(d) ? null : d;
        }
        // tenta ISO/nativo
        const d2 = new Date(s);
        return isNaN(d2) ? null : d2;
      }

      function norm(s) {
        return String(s || "").toLowerCase().trim().replace(/\./g, "");
      }

      function monthLabelFromDate(d) {
        // exemplo: "jul 2026" (sem ponto)
        return norm(d.toLocaleString("pt-BR", { month: "short", year: "numeric" }));
      }

      function splitBullets(text) {
        if (!text) return [];
        const s = String(text).trim();
        if (!s) return [];
        // quebra por \n ou "•" ou ";" (com bom senso)
        const parts = s
          .replace(/\r/g, "")
          .split(/\n|•|;/)
          .map(x => x.trim())
          .filter(Boolean);
        return parts.length ? parts : [s];
      }

      function makeUl(items) {
        if (!items || !items.length) return `<div class="muted">—</div>`;
        return `<ul>${items.map(i => `<li>${escapeHTML(i)}</li>`).join("")}</ul>`;
      }

      // ===== estado (PASSO 4) =====
      let tbl = [];
      let chart_venc = null;
      let activeMonth = null; // "jul 2026"

      function applyFilters() {
        const q = norm(document.getElementById("search").value);
        let rows = tbl;

        // filtro por mês clicado no gráfico
        if (activeMonth) {
          rows = rows.filter(r => {
            const rawVenc = getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento","Vencimento","vigencia_fim"]);
            const d = parseDateAny(rawVenc);
            if (!d) return false;
            return monthLabelFromDate(d) === activeMonth;
          });
        }

        // filtro de texto
        if (q) {
          rows = rows.filter(r => norm(Object.values(r).join(" ")).includes(q));
        }

        render(rows);
      }

      // ===== render tabela =====
      function render(rows) {
        body.innerHTML = "";

        rows.forEach((r, idx) => {
          const ident = getFirst(r, ["identificacao","Identificação","id_instrumento","ID"]);
          const inst  = getFirst(r, ["instituicao_parceira","instituicao","Instituição","instituicao_parceira_nome"]);
          const tipo  = getFirst(r, ["tipo_instrumento","Tipo","tipo"]);
          const proc  = getFirst(r, ["numero_processo","Processo","processo"]);

          const inicio = formatDateBR(getFirst(r, ["vigencia_inicio","VIGÊNCIA - INÍCIO","inicio","Inicio"]));
          const venc   = formatDateBR(getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento","Vencimento","vigencia_fim"]));

          const stat = String(getFirst(r, ["status_vigencia","status_vencimento","Status","status"]) || "").toUpperCase();
          const setor = getFirst(r, ["setor_lotacao","Setor","setor"]);

          const possuiAditivoRaw = getFirst(r, ["possui_aditivo","aditivo","Aditivo"]);
          const qtdAditivosRaw   = getFirst(r, ["quantos_aditivos","Qtd Aditivos","qtd_aditivos"]);
          const possuiAditivo = (possuiAditivoRaw ? String(possuiAditivoRaw) : "").trim().toUpperCase();
          const qtdAditivos   = (qtdAditivosRaw ? String(qtdAditivosRaw) : "").trim();

          let aditivosLabel = "NÃO";
          if (["SIM","S","TRUE","1"].includes(possuiAditivo)) {
            aditivosLabel = qtdAditivos ? `SIM (${qtdAditivos})` : "SIM";
          } else if (["NÃO","NAO","N","FALSE","0",""].includes(possuiAditivo)) {
            aditivosLabel = "NÃO";
          } else if (possuiAditivoRaw) {
            aditivosLabel = String(possuiAditivoRaw);
          }

          const coordParceiro = r.coordenador_parceiro || getFirst(r, ["coord_parceiro","coordenador_parceiro_nome"]) || "";
          const respFvs = r.coordenador_fvsrcp || getFirst(r, ["resp_fvs","responsavel_fvs"]) || "";
          const repasse = r.repasse_financeiro || getFirst(r, ["repasse","valor_repasse"]) || "";

          const objetivoTexto = getFirst(r, ["objetivo_resumido","objetivo_geral","objeto","Objeto"]);
          const produtosTexto = getFirst(r, ["produtos_gerados","produtos_gerados.1","produtos","Produtos"]);

          const objetivoItens = splitBullets(objetivoTexto);
          const produtosItens = splitBullets(produtosTexto);

          const tr = document.createElement("tr");
          const detailsId = `details_${idx}`;
          const btnId = `btn_${idx}`;

          tr.innerHTML = `
            <td>${escapeHTML(ident || "—")}</td>
            <td>${escapeHTML(tipo || "—")}</td>
            <td>${escapeHTML(inst || "—")}</td>
            <td>${escapeHTML(setor || "—")}</td>
            <td>${escapeHTML(stat || "—")}</td>
            <td>${escapeHTML(inicio || "—")}</td>
            <td>${escapeHTML(venc || "—")}</td>
            <td>${escapeHTML(aditivosLabel || "NÃO")}</td>
            <td>${escapeHTML(proc || "—")}</td>
            <td>
              <button class="btn" id="${btnId}">Ver</button>
              <div id="${detailsId}" style="display:none; margin-top:10px;">
                <div class="detailsBox">
                  <div class="kv">
                    <div class="k">Coord. parceiro:</div><div class="v">${escapeHTML(coordParceiro || "—")}</div>
                    <div class="k">Resp. FVS:</div><div class="v">${escapeHTML(respFvs || "—")}</div>
                    <div class="k">Repasse:</div><div class="v">${escapeHTML(repasse || "—")}</div>
                  </div>

                  <details ${objetivoItens.length ? "open" : ""}>
                    <summary>Objetivo</summary>
                    ${makeUl(objetivoItens)}
                  </details>

                  <details>
                    <summary>Produtos</summary>
                    ${makeUl(produtosItens)}
                  </details>
                </div>
              </div>
            </td>
          `;

          body.appendChild(tr);

          const btn = tr.querySelector(`#${btnId}`);
          const box = tr.querySelector(`#${detailsId}`);
          btn.addEventListener("click", () => {
            const open = box.style.display !== "none";
            box.style.display = open ? "none" : "block";
            btn.textContent = open ? "Ver" : "Fechar";
          });
        });
      }

      // ===== gráficos e KPIs =====
      function computeStatus(r) {
        const stat = String(getFirst(r, ["status_vigencia","status_vencimento","Status","status"]) || "").toUpperCase();
        if (stat.includes("SEM DATA") || stat.includes("SEMDATA")) return "SEM DATA";
        if (stat.includes("ALERTA")) return "ALERTA 180 DIAS";
        if (stat.includes("VIGENTE")) return "VIGENTE";
        // fallback por data
        const rawVenc = getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento","Vencimento","vigencia_fim"]);
        const d = parseDateAny(rawVenc);
        if (!d) return "SEM DATA";
        const diffDays = Math.ceil((d - new Date()) / (1000*60*60*24));
        if (diffDays <= 180) return "ALERTA 180 DIAS";
        return "VIGENTE";
      }

      function riskColorByDate(d) {
        // <1 ano = red, 1-2 = yellow, >2 = green
        const now = new Date();
        const diffDays = (d - now) / (1000*60*60*24);
        const diffYears = diffDays / 365.25;
        if (diffYears < 1) return "#d62c26";
        if (diffYears <= 2) return "#f59e0b";
        return "#16a34a";
      }

      function buildChartsAndKPIs() {
        // KPIs e status
        const total = tbl.length;
        let vigentes = 0, alerta = 0, semdata = 0;
        const statusCounts = { "VIGENTE":0, "ALERTA 180 DIAS":0, "SEM DATA":0 };

        tbl.forEach(r => {
          const s = computeStatus(r);
          statusCounts[s] = (statusCounts[s] || 0) + 1;
          if (s === "VIGENTE") vigentes++;
          else if (s === "ALERTA 180 DIAS") alerta++;
          else semdata++;
        });

        kpi_total.textContent = total;
        kpi_vigentes.textContent = vigentes;
        kpi_alerta.textContent = alerta;
        kpi_semdata.textContent = semdata;

        // gráfico status
        Plotly.newPlot("chart_status", [{
          type: "bar",
          x: ["VIGENTE", "ALERTA 180 DIAS", "SEM DATA"],
          y: [statusCounts["VIGENTE"], statusCounts["ALERTA 180 DIAS"], statusCounts["SEM DATA"]],
        }], {
          margin: { t: 10, r: 10, b: 40, l: 40 },
          height: 320,
        }, { displayModeBar:false, responsive:true });

        // gráfico vencimentos por mês (com cores por risco)
        const monthMap = new Map(); // key -> {count, color}
        tbl.forEach(r => {
          const rawVenc = getFirst(r, ["vigencia_termino","VIGÊNCIA - TÉRMINO","vencimento","Vencimento","vigencia_fim"]);
          const d = parseDateAny(rawVenc);
          if (!d) return;
          const key = monthLabelFromDate(d); // ex: "jul 2026"
          const prev = monthMap.get(key) || { count:0, color: riskColorByDate(d) };
          prev.count += 1;
          // mantém a cor do "pior caso" (se houver mistura no mesmo mês, tende pro mais crítico)
          const c = riskColorByDate(d);
          const priority = (hex) => hex === "#d62c26" ? 3 : (hex === "#f59e0b" ? 2 : 1);
          if (priority(c) > priority(prev.color)) prev.color = c;
          monthMap.set(key, prev);
        });

        const months = Array.from(monthMap.keys()).sort((a,b) => {
          // a/b são "jul 2026"
          const parseKey = (k) => {
            const [mon, year] = k.split(" ");
            const mMap = {jan:0,fev:1,mar:2,abr:3,mai:4,jun:5,jul:6,ago:7,set:8,out:9,nov:10,dez:11};
            return new Date(Number(year), mMap[mon] ?? 0, 1).getTime();
          };
          return parseKey(a) - parseKey(b);
        });

        const y = months.map(m => monthMap.get(m).count);
        const colors = months.map(m => monthMap.get(m).color);

        chart_venc = document.getElementById("chart_venc");
        Plotly.newPlot(chart_venc, [{
          type: "bar",
          x: months.map(m => m.replace(/(^\w)/, c => c.toUpperCase())), // só estética no eixo
          y,
          marker: { color: colors }
        }], {
  height: 320,
  xaxis: {
    tickangle: -45,
    automargin: true
  },
  margin: {
    t: 30,
    r: 20,
    b: 90,
    l: 50
  }
}, { displayModeBar:false, responsive:true });

        // reatribui o handler do clique com base no eixo "bonitinho"
        chart_venc.on("plotly_click", (data) => {
          if (!data || !data.points || !data.points.length) return;
          // x vem com a primeira letra maiúscula no gráfico; normaliza para comparar com monthLabelFromDate()
          const clicked = norm(data.points[0].x);
          activeMonth = (activeMonth === clicked) ? null : clicked;
          applyFilters();
        });
      }

      // ===== carregar CSV =====
      const parsed = await new Promise((resolve, reject) => {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      // Se o arquivo não carregou / veio vazio / teve erro de download, force erro
      if (res.errors && res.errors.length) {
        console.error("PapaParse errors:", res.errors);
      }
      const rows = res.data || [];
      if (!rows.length) {
        reject(new Error(`CSV vazio ou não encontrado em: ${CSV_URL}`));
        return;
      }
      resolve(rows);
    },
    error: (err) => reject(err)
  });
});

tbl = parsed;

      // constroi gráficos + KPIs
      buildChartsAndKPIs();

      // PASSO 4: render inicial + busca combinada
      document.getElementById("search").addEventListener("input", applyFilters);
      applyFilters(); // tabela completa
// Botão "Ver todos" (reset geral)
const resetBtn = document.getElementById("resetFilters");
resetBtn.addEventListener("click", () => {
  activeMonth = null;   // limpa filtro do gráfico
  search.value = "";   // limpa busca
  applyFilters();      // redesenha tabela completa
});
    })().catch(err => {
      console.error("[INIT] ERRO:", err);
      alert("Erro ao carregar o CSV. Abra o Console (F12) para ver o detalhe.");
    });
  </script>
</body>
</html>